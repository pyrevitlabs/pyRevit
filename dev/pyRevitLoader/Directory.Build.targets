<?xml version="1.0" encoding="UTF-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Import Project="../Directory.Build.targets"/>

    <ItemGroup>
        <None Remove="obj\**" />
    </ItemGroup>
    
    <ItemGroup Condition="$(UseLoader)==True">
        <Compile Include="..\Source\PyRevitLoaderApplication.cs" Link="Source\PyRevitLoaderApplication.cs"/>
        <Compile Include="..\Source\ScriptExecutor.cs" Link="Source\ScriptExecutor.cs"/>
    </ItemGroup>

    <ItemGroup Condition="$(UseRunner)==True">
        <Compile Include="..\Source\PyRevitRunnerApplication.cs" Link="Source\PyRevitRunnerApplication.cs"/>
        <Compile Include="..\Source\PyRevitRunnerCommand.cs" Link="Source\PyRevitRunnerCommand.cs"/>
        <Compile Include="..\Source\ScriptExecutor.cs" Link="Source\ScriptExecutor.cs"/>
    </ItemGroup>

    <ItemGroup Condition="'$(UseIronPython)' != 'false' AND $(IronPythonVersion.Contains('PR'))">
        <Reference Include="IronPython" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.IronPython.dll"/>
        <Reference Include="IronPython.Modules" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.IronPython.Modules.dll"/>
        <Reference Include="IronPython.SQLite" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.IronPython.SQLite.dll"/>
        <Reference Include="IronPython.Wpf" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.IronPython.Wpf.dll"/>
        <Reference Include="Microsoft.Dynamic" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.Microsoft.Dynamic.dll"/>
        <Reference Include="Microsoft.Scripting" HintPath="$(PyRevitEnginesDir)\$(IronPythonVersion)\pyRevitLabs.Microsoft.Scripting.dll"/>
    </ItemGroup>

    <ItemGroup Condition="'$(UseIronPython)' != 'false' AND !$(IronPythonVersion.Contains('PR'))">
        <PackageReference Include="IronPython" Version="$(Version)"/>
    </ItemGroup>
    
    <ItemGroup>
        <Reference Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework'" Include="Microsoft.CSharp"/>
    </ItemGroup>
    
    <ItemGroup Condition="'$(UseAssemblyBuilder)' == 'true'">
        <ProjectReference Include="..\pyRevitAssemblyBuilder\pyRevitAssemblyBuilder.csproj" />
    </ItemGroup>
    
    <ItemGroup Condition="'$(UseExtensionParser)' == 'true'">
        <ProjectReference Include="..\pyRevitExtensionParser\pyRevitExtensionParser.csproj" />
    </ItemGroup>
    
    <ItemGroup Condition="'$(UseIronPython)' != 'false'">
        <EmbeddedResource Include="$(IronPythonStdLibDir)\$(IronPythonStdLib)"/>
    </ItemGroup>
    
    <ItemGroup Condition="'$(UseRoslyn)' == 'true'">
        <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="4.13.0" />
    </ItemGroup>
    
    <ItemGroup Condition="'$(UseILPack)' == 'true'">
        <PackageReference Include="Lokad.ILPack" Version="0.3.0" ExcludeAssets="runtime" />
    </ItemGroup>
    
    <Target Name="Deploy" AfterTargets="AfterBuild">
        <ItemGroup>
            <AllFilesToCopy Include="$(TargetDir)\**\*.dll"
                            Exclude="$(TargetDir)\**\Xceed.Wpf.AvalonDock.dll;
                                     $(TargetDir)\**\Microsoft.CodeAnalysis.dll;
                                     $(TargetDir)\**\Microsoft.CodeAnalysis.CSharp.dll;
                                     $(TargetDir)\**\Microsoft.CodeAnalysis.CSharp.resources.dll;
                                     $(TargetDir)\**\Microsoft.CodeAnalysis.resources.dll;
                                     $(TargetDir)\**\System.*.dll"
                            Condition="'$(IsTestProject)' != 'true'"/>
        </ItemGroup>
        <Copy SourceFiles="@(AllFilesToCopy)" 
                DestinationFolder="$(PyRevitEnginesDir)\$(IronPythonVersion)" />
        <Message Importance="high" 
                Text="$(MSBuildProjectName) -> Copy to $([System.IO.Path]::GetFullPath('$(PyRevitEnginesDir)\$(IronPythonVersion)'))" />
    </Target>

</Project>